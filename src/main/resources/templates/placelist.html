<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="utf-8">
<title>CurtainCall</title>
<link rel="stylesheet" href="/css/placelist.css">

<link href="https://webfontworld.github.io/NanumSquareNeo/NanumSquareNeo.css" rel="stylesheet">
<script src="https://kit.fontawesome.com/fe66fff399.js"	crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script th:inline="javascript">
    var la = [[${ list[0].la }]];
    var lo = [[${ list[0].lo }]];
    //console.log(la,lo);

    $(document).ready(function () {
        var urlParams = new URLSearchParams(window.location.search);
        var placeId = urlParams.get('placeId');

        // ì²« ë²ˆì§¸ íƒ­ì„ ê¸°ë³¸ìœ¼ë¡œ ì„¤ì •
        if (placeId) {
            var tabId = "place" + placeId;
            var playId = "play" + placeId;

            openTab(tabId, placeId);
            setTimeout(function () {
                openTab2(playId);
            }, 0);
        } else {
            var firstPlaceId = $(".place-link > a:first").parent().data("place-id");
            var firstTabId = "place" + firstPlaceId;
            var firstPlayTabId = "play" + firstPlaceId;

            openTab(firstTabId, firstPlaceId);
            setTimeout(function () {		// ì²« ë²ˆì§¸ íƒ­ì˜ ì²« ë²ˆì§¸ í•˜ìœ„ íƒ­ì„ ì„ íƒ
                openTab2(firstPlayTabId);
            }, 0);
        }

        //ì¥ì†Œ íƒ­
        $(".place-link").click(function () {
            var tabId = $(this).data("tab");
            var placeId = $(this).data("place-id");
            var playTab = "play" + placeId;

            openTab(tabId, placeId);
            openTab2(playTab);		//defaultê°’ìœ¼ë¡œ ì—°ê·¹íƒ­ ì„ íƒ
        });

        //ì—°ê·¹/ë§›ì§‘ íƒ­
        $(".play-link").click(function () {
            var tabId = $(this).data("tab");
            openTab2(tabId);
        });

        function openTab(tabId, placeId) {
            $(".place-link").removeClass("active");
            $(".place-content").removeClass("active");

            $("#" + tabId).addClass("active");
            $("[data-tab=" + tabId + "]").addClass("active");

            la = $("#" + tabId).find("input[name=place_la]").val();
            lo = $("#" + tabId).find("input[name=place_lo]").val();

            window.history.pushState(null, null, "/place?placeId=" + placeId);	// URL ë³€ê²½
        }

        function openTab2(tabId) {
            $(".play-link").removeClass("active");
            $(".play-content").removeClass("active");

            $("[data-tab=" + tabId + "]").addClass("active");
            $("#" + tabId).addClass("active");

            if(tabId.includes("eat")){		//ë§›ì§‘íƒ­ì¼ ê²½ìš°ì—ë§Œ ì§€ë„ ë¶ˆëŸ¬ì˜¤ê¸°
            	$(".eat-content").empty();
                initMap(tabId);	//í˜„ì¬ ìœ„ì¹˜ ì¤‘ì‹¬ìœ¼ë¡œ ë§›ì§‘ ê°€ì ¸ì˜¤ê¸°
            }
        }

      	//ì¥ì†Œë³„ ì§€ë„ ë° ë§›ì§‘ ë¦¬ìŠ¤íŠ¸ ì¶œë ¥
        var maps = [];
        var markers = [];
        var infoWindows = [];	//ë§ˆì»¤ë³„ ì •ë³´ ì°½ ì €ì¥ ë³€ìˆ˜
        var currentInfoWindow = null; // í˜„ì¬ ì—´ë¦° ì •ë³´ ì°½ ë³€ìˆ˜

        function initMap(tabId) {
            var mapDivId = document.getElementById(tabId).querySelector("#map");
            console.log(mapDivId);
            var place = new google.maps.LatLng(la, lo);
            var mapOptions = {
                center: place,
                zoom: 16
            };

            maps[tabId] = new google.maps.Map(mapDivId, mapOptions);
            markers[tabId] = [];
            infoWindows[tabId] = [];

            var placesService = new google.maps.places.PlacesService(maps[tabId]);
            var request = {
                location: place,
                radius: 1200, // ê²€ìƒ‰ ë°˜ê²½ ì„¤ì • (ë¯¸í„° ë‹¨ìœ„)
                type: "restaurant"
            };

            // í˜„ì¬ ì¥ì†Œ ìœ„ì¹˜ì—ë„ ë§ˆì»¤ í‘œì‹œ
            var centerMarker = new google.maps.Marker({
                position: place,
                map: maps[tabId],
                icon: {
                    url: "https://maps.google.com/mapfiles/ms/icons/yellow-dot.png",
                    scaledSize: new google.maps.Size(40, 40),
                    anchor: new google.maps.Point(10, 40)
                }
            });
            markers[tabId].push(centerMarker);
            
            placesService.nearbySearch(request, function (results, status) {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    for (let i = 0; i < results.length; i++) {
                        if (results[i].rating >= 4.0) {
                            $(".eat-content").append(`
                                <a class="eat-place" href="#">
                                  <div class="eat-head">
                                    <div class="eat-title">${results[i].name}</div>
                                  </div>
                                  <p class="eat-side">
                                    <span><i class="fa-solid fa-star" style="color: #F5D042"></i> ${results[i].rating}</span>
                                    <span>&nbsp;&nbsp;</span>
                                    <span>ë¦¬ë·° ${results[i].user_ratings_total}</span>
                                  </p>
                                </a>
                             `);

                            // ì¥ì†Œì˜ ìœ„ì¹˜ì— ë§ˆì»¤ í‘œì‹œ
                            var placeLocation = results[i].geometry.location;
                            var marker = new google.maps.Marker({
                                position: placeLocation,
                                map: maps[tabId]
                            });
                            markers[tabId].push(marker);

                            var placeId = results[i].place_id;
                            var mapLink = `https://www.google.com/maps/place/?q=place_id:${placeId}`;

                            // ì •ë³´ ì°½ ìƒì„±
                            var infoWindow = new google.maps.InfoWindow({
                                content: `
								  <div>
							      <h3><a href="${mapLink}" target="_blank" title="Google ì§€ë„ì—ì„œ ë³´ê¸°" class="map-title">${results[i].name}</a></h3>
							      <p>${results[i].plus_code.compound_code.slice(8)}&nbsp;${results[i].vicinity}</p>
							    </div>
							  `
                            });
                            infoWindows[tabId].push(infoWindow);

                            // ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬
                            marker.addListener("click", function (marker, infoWindow, result) {
                                return function () {
                                    var placeId = result.place_id;
    								var mapLink = `https://www.google.com/maps/place/?q=place_id:${placeId}`;
                                    // í˜„ì¬ ì—´ë¦° ì •ë³´ ì°½ì´ ìˆìœ¼ë©´ ë‹«ê¸°
                                    if (currentInfoWindow) {
                                        currentInfoWindow.close();
                                    }

                                    var content = `
						            <div>
						                <h3><a href="${mapLink}" target="_blank" title="Google ì§€ë„ì—ì„œ ë³´ê¸°" class="map-title">${results[i].name}</a></h3>
						                <p>${results[i].plus_code.compound_code.slice(8)}&nbsp;${results[i].vicinity}</p>
						            </div>
						        	`;

						        	var infoWindow = new google.maps.InfoWindow({
                                        content: content
                                    });
                                    infoWindows[tabId].push(infoWindow);

                                    // ì •ë³´ ì°½ ì—´ê¸°
                                    infoWindow.open(maps[tabId], marker);
                                    currentInfoWindow = infoWindow;
                                };
                            }(marker, infoWindow, results[i]));
                        }
                    }
                }
            })
        }
        
     	// ë§›ì§‘ ë¦¬ìŠ¤íŠ¸ í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬
        $(".eat-content").on("click", ".eat-place", function(event) {
            event.preventDefault(); // ê¸°ë³¸ ë™ì‘ ë°©ì§€
            var tabId = $(this).closest(".play-content").attr("id");
            var placeId = $(this).index();
            //console.log("index: "+ placeId);
            
		    // í˜„ì¬ ì—´ë¦° ì •ë³´ ì°½ì´ ìˆìœ¼ë©´ ë‹«ê¸°
		    if (currentInfoWindow) {
		    	currentInfoWindow.close();
		    }
            // í´ë¦­í•œ ì¥ì†Œì˜ ë§ˆì»¤ì™€ ì •ë³´ ì°½ í‘œì‹œ
            markers[tabId][placeId+1].setVisible(true);
            infoWindows[tabId][placeId].open(maps[tabId], markers[tabId][placeId+1]);
            
            currentInfoWindow = infoWindows[tabId][placeId];
            
            return false; // ì¶”ê°€: í´ë¦­ ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€
        });
    });
</script>
<th:block th:include="header :: head"></th:block>
</head>
<body>
	<!-- Header -->
	<th:block th:include="header :: body"></th:block>

	<!-- Body Wrap -->
	<div id="content-wrap">
		<h1 id="theater-list-title">ê³µì—°ì¥</h1>
		<hr>

		<!-- ê³µì—°ì¥ ë¦¬ìŠ¤íŠ¸ íƒ­ -->
		<div class="tab-container">
			<div class="tab-controls">
				<button class="prev-btn" onclick="prevButtonClick()">
					<i class="fas fa-chevron-left"></i>
				</button>
			</div>
			<div class="tab-place slider">
				<ul class="tab-row">
					<li th:each="item, itemStat : ${list}" class="place-link"
						th:data-tab="'place' + ${item.placeId}" th:data-place-id="${item.placeId}"> 
						<a th:text="${item.placeName}"></a>
					</li>
				</ul>
			</div>
			<div class="tab-controls">
				<button class="next-btn" onclick="nextButtonClick()">
					<i class="fas fa-chevron-right"></i>
				</button>
			</div>
			<input type="hidden" id="currentTabIndex" th:value="${currentTabIndex}" />
			<input type="hidden" id="numVisibleTabs" th:value="${numVisibleTabs}" />
			<input type="hidden" id="maxTabIndex" th:value="${maxTabIndex}" />
		</div>

		<!-- Tab ë¶€ë¶„ -->
		<div th:each="item, itemStat : ${list}"
			 th:with="playList=${listPlay[itemStat.index]}">
			<div th:id="'place' + ${item.placeId}" th:data-place-id="${item.placeId}" class="place-content">
				<input type="hidden" name="place_la" th:value="${item.la}">
				<input type="hidden" name="place_lo" th:value="${item.lo}">
				<div class="placeInfo">
					<div class="info-content">
						<h3 th:text=${item.placeName}></h3>
						<div>
							<b>ì£¼ &nbsp;&nbsp;&nbsp;&nbsp; ì†Œ : </b>
							<span th:text="${item.placeAddr}"></span>
						</div>
						<div>
							<b>ì „ &nbsp;&nbsp;&nbsp;&nbsp; í™” :</b> 
							<span th:text="${item.placePhone}"></span>
						</div>
						<div class="link">
							<div class="link-label"><b>í™ˆí˜ì´ì§€ :</b></div>
							<div class="link-detail">
								<a th:href="${item.placeLink}" target="_blank">
									<span th:text="${item.placeLink}" class="homepage"></span>
								</a>
							</div>
							<div><i class="fa-solid fa-share-from-square innerIcon"></i></div>
						</div>
					</div>
				</div>
				
				<!-- ì—°ê·¹/ë§›ì§‘ íƒ­ -->
				<ul class="tabs">
					<li class="play-link active" th:data-tab="'play' + ${item.placeId}" th:data-place-id="${item.placeId}">ì—°ê·¹</li>
					<li class="play-link" th:data-tab="'eat' + ${item.placeId}" th:data-place-id="${item.placeId}">ë§›ì§‘</li>
				</ul>
	
				<!-- ì—°ê·¹ ë¦¬ìŠ¤íŠ¸ -->
				<div th:id="'play' + ${item.placeId}" class="play-content" th:data-place-id="${item.placeId}">
					<div th:if="${#lists.isEmpty(playList)}" class="no-playList">
						<p>ìƒì˜ì¤‘ì¸ ì—°ê·¹ì´ ì—†ìŠµë‹ˆë‹¤ğŸ™‚</p>
					</div>
					<div th:if="${!#lists.isEmpty(playList)}" class="theater-content">
						<div class="theater-unit" th:each="play : ${playList}" >
							<div class="img-wrap">
								<a class="theater-link" th:href="@{/play/detail(playId=${play.playId})}" title="ì—°ê·¹ ë³´ê¸°">
									<img th:src="@{${play.playPoster}}" th:alt='${play.playTitle}'>
								</a>
							</div>
							<h4 th:text='${play.playTitle}'></h4>
							<div class="reservation-btn">
								<a th:href="@{/play/detail(playId=${play.playId})}">ì˜ˆë§¤í•˜ê¸°</a>
							</div>
						</div>
					</div>
				</div>
				
		
				<!-- ë§›ì§‘ ë¦¬ìŠ¤íŠ¸ -->
				<div th:id="'eat' + ${item.placeId}" class="play-content" th:data-place-id="${item.placeId}">		
					<div id="map"></div>
					<div class="eat-content">
						<a class="eat-place" href="#">
							<div class="eat-head">
								<!-- <div class="eat-title"></div> -->
							</div>
							<p class="eat-side">
								<!-- <span>í”¼ì</span>&nbsp;&nbsp; <span>ë¦¬ë·°999+</span> -->
							</p>
						</a>
					</div>				
				</div>
			</div>
		</div>			
	</div>

	<script th:inline="javascript">
		var numVisibleTabs = parseInt($("#numVisibleTabs").val());
		var maxTabIndex = parseInt($("#maxTabIndex").val());
		
		function nextButtonClick() {
			var currentTabIndex = parseInt(localStorage.getItem("currentTabIndex")) || 0;
		    if (currentTabIndex + numVisibleTabs < maxTabIndex) {
		        currentTabIndex += numVisibleTabs;
		        localStorage.setItem("currentTabIndex", currentTabIndex);
		        console.log("currentIdex: " + currentTabIndex);
		        showTabs();
		    }
		}
		function prevButtonClick() {
			var currentTabIndex = parseInt(localStorage.getItem("currentTabIndex")) || 0;
		    if (currentTabIndex > 0) {
		        currentTabIndex -= numVisibleTabs;
		        localStorage.setItem("currentTabIndex", currentTabIndex);
		        console.log("currentIdex: " + currentTabIndex);
		        showTabs();
		    }
		}
		function showTabs() {
			var currentTabIndex = parseInt(localStorage.getItem("currentTabIndex")) || 0;
		    $(".tab-row > li").hide();
		    $(".tab-row > li").slice(currentTabIndex, currentTabIndex + numVisibleTabs).show();
		}
	
	    $(document).ready(function() {
	        showTabs();
	    });
	</script>
	<script
		src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMg74sWHciF_btGAmqaRn5NP1Ld46yOfE&libraries=places&callback=initMap" async defer>
	</script>

	<!-- Footer -->
	<th:block th:replace="footer :: footer"></th:block>
</body>
</html>
